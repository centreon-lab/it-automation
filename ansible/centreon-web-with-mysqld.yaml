---
- hosts: centreon-web

  tasks:
    - name: add package necessary to manage selinux (if enabled)
      yum:
        name: libselinux-python
        state: present
      when: ansible_distribution == "CentOS"
    - name: disable selinux (default)
      selinux:
        state: disabled
      when: ansible_distribution == "CentOS"

    - name: add repo centreon centos6
      get_url:
        url: http://yum.centreon.com/standard/3.4/el6/stable/centreon-stable.repo
        dest: /etc/yum.repos.d
        mode: 0644
      when: ansible_distribution == "CentOS" and ansible_distribution_major_version == "6"

    - name: add repo centreon centos7
      get_url:
        url: http://yum.centreon.com/standard/3.4/el7/stable/centreon-stable.repo
        dest: /etc/yum.repos.d
        mode: 0644
      when: ansible_distribution == "CentOS" and ansible_distribution_major_version == "7"

    - name: add rpm key to centreon repository (CentOS6)
      rpm_key:
        state: present
        key: http://yum.centreon.com/standard/3.4/el6/stable/RPM-GPG-KEY-CES
      when: ansible_distribution == "CentOS" and ansible_distribution_major_version == "6"

    - name: add rpm key to centreon repository (CentOS7)
      rpm_key:
        state: present
        key: http://yum.centreon.com/standard/3.4/el7/stable/RPM-GPG-KEY-CES
      when: ansible_distribution == "CentOS" and ansible_distribution_major_version == "7"

    - name: install centreon web and requirements
      yum:
        name:
          - centreon-base-config-centreon-engine
          - centreon
          - MariaDB-server
        state: latest

    - name: php timezone configuration
      copy:
        dest: /etc/php.d/php-timezone.ini
        content: |
          date.timezone = Europe/Paris

    - name: Generate SSH keys
      shell: su - centreon -c 'ssh-keygen -t rsa -f /var/spool/centreon/.ssh/id_rsa -q -N ""'
      args:
        creates: /var/spool/centreon/.ssh/id_rsa

    - name: httpd service
      service: name=httpd enabled=yes state=started
    - name: snmpd service
      service: name=snmpd enabled=yes state=started
    - name: mysql service
      service: name=mysql enabled=yes state=started
    - name: centcore service
      service: name=centcore enabled=yes
    - name: centengine service
      service: name=centengine enabled=yes
    - name: cbd service
      service: name=cbd enabled=yes
    - name: Enable firewalld
      service: name=firewalld state=started enabled=yes
      when: ansible_distribution == "CentOS" and ansible_distribution_major_version == "7"

    - name: Firewall allow http
      firewalld:
        service: http
        permanent: true
        state: enabled
        immediate: yes
      when: ansible_distribution == "CentOS" and ansible_distribution_major_version == "7"

    - name: Firewall allow broker
      firewalld:
        port: 5669/tcp
        permanent: true
        state: enabled
        immediate: yes
      when: ansible_distribution == "CentOS" and ansible_distribution_major_version == "7"
